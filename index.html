<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>ld35!</title>
        <script src="phaser.min.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        var game = new Phaser.Game(800, 600, Phaser.AUTO, '',
                                   {preload: preload,
                                    create: create,
                                    update: update });

        function preload () {
            game.load.spritesheet('ship', 'ship.png', 64, 64, 24);
            game.load.image('bg', 'bg.png');

            game.load.spritesheet('enemy', 'enemies.png', 64, 64, 8);

            game.load.audio('shoot', 'shoot.mp3');
            game.load.audio('reattach', 'reattach.mp3');
            game.load.audio('explosion', 'explosion.mp3');

        }

        var player;
        var cursors;
        var fire;
        var spaceKey;

        var enemies;

        var sfxShoot;
        var sfxReattach;
        var sfxExplosion;

        function create () {
            game.add.sprite(0, 0, 'bg');

            sfxShoot = game.add.audio('shoot');
            sfxReattach = game.add.audio('reattach');
            sfxExplosion = game.add.audio('explosion');

            createPlayer();

            enemies = game.add.group();

            // Our controls
            cursors = game.input.keyboard.createCursorKeys();
            this.spaceKey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
            game.input.keyboard.addKeyCapture([ Phaser.Keyboard.SPACEBAR, ]);
        }

        function update() {
            var velocity = 0.40;

            if (cursors.left.isDown) {
                // Move to the left
                player.x -= game.time.elapsed * velocity;
                if (player.x < 0) {
                    player.x = 0;
                }
            } else if (cursors.right.isDown) {
                // Move to the right
                player.x += game.time.elapsed * velocity;
                if (player.x > game.world.width) {
                    player.x = game.world.width;
                }
            }

            if (this.spaceKey.isDown) {
                player.fireBullet();
            } else {
                player.lastFired = 0; // reset fire tracker on key up
            }

            if (bullets.length > 0) {
                updateBullets();
            }

            updateEnemies();
        }

        /* Player */
        function createPlayer() {
            player = game.add.sprite(64, game.world.height - 90, 'ship', 6);
            player.anchor.x = 0.5;
            player.anchor.y = 0.5;

            fire = game.add.sprite(0, 56, 'ship', 13);
            fire.anchor.x = 0.5;
            fire.anchor.y = 0.5;

            player.addChild(fire);

            fire.animations.add('run', [13, 12], 5, true);
            fire.animations.play('run');

            player.numBullets = 6;

            bullets = game.add.group();

            player.lastFired = 0;
            player.fireBullet = function() {
                if (player.numBullets == 0) {
                    return; // can't shoot if we have no bullets
                }

                if (game.time.now > player.lastFired + 250) {
                    player.lastFired = game.time.now;
                    player.numBullets--;
                    player.frame = player.numBullets;
                    createBullet();
                }
            };
        }

        function updateBullets() {
            // for each bullet in the bullet group
            // move it upwards until it reaches the end of the screen
            // move it towards the player on the x and y axis
            // if the bullet has reached the player, then inc player bullets and destroy bullet

            var BULLET_SPEED = 0.6;

            for (var i = 0; i < bullets.children.length; i++) {
                var bullet = bullets.children[i];

                bullet.angle += game.time.elapsed * BULLET_SPEED;

                if (bullet.up) {
                    bullet.y -= game.time.elapsed * BULLET_SPEED;

                    if (bullet.y < 5) {
                        bullet.up = false;
                    }
                } else {
                    if (bullet.y <= player.y) {
                        bullet.y += game.time.elapsed * BULLET_SPEED;
                    }

                    var playerBulletDelta = player.x - bullet.x;
                    bullet.x += playerBulletDelta * (BULLET_SPEED / 5);

                    if (bullet.y > player.y && Math.abs(playerBulletDelta) < 20) {
                        bullet.destroy();
                        sfxReattach.play();
                        player.numBullets++;
                        player.frame = player.numBullets;
                    }
                }
            }

        }

        function createBullet() {
            // add a new bullet to the game and to the bullet group
            var activeBullet = game.add.sprite(player.x, player.y, 'ship', 8);
            activeBullet.anchor.x = 0.5;
            activeBullet.anchor.y = 0.5;
            activeBullet.up = true;
            bullets.add(activeBullet);
            sfxShoot.play();
        }

        /* enemies */

        function addEnemy(x, y) {
            var enemy = game.add.sprite(x, -80, 'enemy', 1);
            enemy.anchor.x = 0.5;
            enemy.anchor.y = 0.5;

            enemy.targetX = x;
            enemy.targetY = y;

            enemies.add(enemy);
        }

        function addWave() {
            var ySpacing = game.world.width / 6;

            addEnemy(ySpacing * 1, 80);
            addEnemy(ySpacing * 2, 120);
            addEnemy(ySpacing * 3, 80);
            addEnemy(ySpacing * 4, 120);
            addEnemy(ySpacing * 5, 80);
        }

        function updateEnemies() {
            if (enemies.length == 0) {
                addWave();
            }

            var ENEMY_SPEED = 0.1;

            for (var i = 0; i < enemies.children.length; i++) {
                var enemy = enemies.children[i];

                if (enemy.y < enemy.targetY) {
                    enemy.y += game.time.elapsed * ENEMY_SPEED;
                }

                checkEnemyBulletCollisions(enemy);
            }
        }

        function checkEnemyBulletCollisions(enemy) {
            for (var i = 0; i < bullets.children.length; i++) {
                var bullet = bullets.children[i];

                if (spritesCollide(bullet, enemy, 0.2)) {
                    enemy.destroy();
                    sfxExplosion.play();

                    var explosionEmitter = game.add.emitter(0, 0, 100);
                    explosionEmitter.makeParticles('enemy', 4);
                    explosionEmitter.x = bullet.x;
                    explosionEmitter.y = bullet.y;
                    explosionEmitter.gravity = 0;
                    explosionEmitter.autoAlpha = true;
                    explosionEmitter.setAlpha(1, 0, 800);
                    explosionEmitter.start(true, 800, null, 20);
                }
            }
        }

        /* utils */

        function spritesCollide(a, b, overlapPercent) {
            overlapPercent = overlapPercent == undefined ? 1 : overlapPercent;

            return (Math.abs(a.x - b.x) * 2 < (a.width * overlapPercent + b.width)) &&
                   (Math.abs(a.y - b.y) * 2 < (a.height * overlapPercent + b.height));
        }

    };
    </script>

    </body>
</html>