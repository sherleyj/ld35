<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>ld35!</title>
        <script src="phaser.min.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        var game = new Phaser.Game(800, 600, Phaser.AUTO, '',
                                   {preload: preload,
                                    create: create,
                                    update: update });

        function preload () {
            game.load.spritesheet('ship', 'ship.png', 64, 64, 24);
            game.load.image('bg', 'bg.png');

        }

        var player;
        var cursors;
        var fire;
        var spaceKey;
        var bullet;

        function create () {
            game.add.sprite(0, 0, 'bg');

            createPlayer();

            // Our controls
            cursors = game.input.keyboard.createCursorKeys();
            this.spaceKey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
            game.input.keyboard.addKeyCapture([ Phaser.Keyboard.SPACEBAR, ]);
        }

        function update() {
            var velocity = 0.40;

            if (cursors.left.isDown) {
                // Move to the left
                player.x -= game.time.elapsed * velocity;
                if (player.x < 0) {
                    player.x = game.world.width;
                }
            } else if (cursors.right.isDown) {
                // Move to the right
                player.x += game.time.elapsed * velocity;
                if (player.x > game.world.width) {
                    player.x = 0;
                }
            }

            if(this.spaceKey.isDown) {
               player.fireBullet(); 
            }

            // TODO - figure out delay
            // if (game.input.keyboard.event && game.input.keyboard.event.code == "Space") {
            //     player.fireBullet();
            //     game.input.keyboard.event = null;
            // }
        }

        /* Player */
        function createPlayer() {
            player = game.add.sprite(64, game.world.height - 90, 'ship', 2);
            fire = game.add.sprite(0, 56, 'ship', 13);
            player.addChild(fire);

            fire.animations.add('run', [13, 12], 5, true);
            fire.animations.play('run');

            bullets = game.add.group();

            player.lastFired = 0;
            player.fireBullet = function() {
                if (game.time.now > player.lastFired - 50) {
                    console.log("BOOM");
                    player.lastFired = game.time.now;
                }
            };
        }

        /* utils */

        function spritesCollide(a, b, overlapPercent) {
            overlapPercent = overlapPercent == undefined ? 1 : overlapPercent;

            return (Math.abs(a.x - b.x) * 2 < (a.width * overlapPercent + b.width)) &&
                   (Math.abs(a.y - b.y) * 2 < (a.height * overlapPercent + b.height));
        }

    };
    </script>

    </body>
</html>